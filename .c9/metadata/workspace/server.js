{"changed":true,"filter":false,"title":"server.js","tooltip":"/server.js","value":"var express = require('express');\nvar crypto = require('crypto');\nvar moment = require('moment');\nvar bodyParser = require('body-parser');\nvar cookieParser = require('cookie-parser');\nvar session = require('express-session');\nvar net = require('net');\nvar pass = require('pwd');\nvar app = express();\n\nvar httpport = 8080;\nvar port = 30059;\nvar guestId = 0;\nvar timezone = -8;\nvar heartbeat_check_interval = 1000 * 30;\n\nvar data_obj = require('./redis.js');\nvar socket_obj = require('./socket.js');\nvar wechat_obj = require('./wechat.js');\n\nvar ERR_NULL_ID = {\"error\":\"NULLID\"};\nvar UserDelete = {\n    \"IsSuccess\" : \"false\"\n};\n\nvar Users = {\n\t\"USERNAME\"  : \"\",\n\t\"EMAIL\"  : \"\",\n\t\"SALT\"\t: \"\",\n\t\"HASH\"\t: \"\",\n\t\"DEVICEID\"  : \"\",\n\t\"DEVICEID2\"  : \"\",\n\t\"TOKIN\"  : \"\"\n};\n\nvar DeviceState = {\n\t\"DeviceId\"  : \"00000000\",\n\t\"IsSuccess\" : true,\n\t\"NSlots\"    : 5,\n\t\"State\"     : \"00000\",\n\t\"IsOnline\"  : false,\n\t\"Heartbeat\" : 0,\n\t\"ServerTime\": \"2014-5-19 14:47:56\"\n};\n\nfunction heartbeat_timer() {\n    //console.log(\"heartbeating..\");\n    //online tree traversal.\n    //and dicrease 1 heartbeat counter to every online device.\n}\n\nvar tcp_server = net.createServer(function(socket) {\n\t// Increment\n\tguestId++;\n\tsocket.nickname = \"Client_\" + guestId;\n\tvar clientName = socket.nickname;\n\tsocket_obj.pushsocket(socket);\n\t// Log it to the server output\n\tconsole.log(clientName + ' connected.');\n\t// Welcome user to the socket\n\tsocket.write(\"Hi \"+ clientName +\" Welcome!\\n\");\n\t// Broadcast to others excluding this socket\n\t//broadcast(clientName, clientName + ' joined this chat.\\n');\n\t// When client sends data\n\tsocket.on('data', function(data) {\n\t\t//var message = clientName + '> ' + data.toString();\n\t\t//broadcast(clientName, message);\n\t\t//parse packet,find device id.\n\t\tconsole.log(data.toString());\n\t\t//set device heartbeat counter to N(similer to TTL). mybe N = heartbeat_check_interval × 6\n\t});\n\t// When client leaves\n\tsocket.on('end', function() {\n\t\tvar message = clientName + ' disconnected\\n';\n\t\tconsole.log(message);\n\t\tsocket_obj.removeSocket(socket);\n\t\t//broadcast(clientName, message);\n\t});\n\t// When socket gets errors\n\tsocket.on('error', function(error) {\n\t\tconsole.log('Socket got problems: ', error.message);\n\t});\n});\n\n// Listening for any problems with the server\ntcp_server.on('error', function(error) {\n\tconsole.log(\"So we got problems!\", error.message);\n});\n\n// Listen for a port to telnet to\n// then in the terminal just run 'telnet localhost [port]'\ntcp_server.listen(port, function() {\n\tconsole.log(\"TCP   listening on port :\" + port);\n});\n\napp.use(express.static(__dirname + '/public'));\napp.use(bodyParser());\napp.use(cookieParser('shhhh, very secret'));\napp.use(session());\n\napp.use(function(req, res, next){\n    var err = req.session.error;\n    var msg = req.session.success;\n    delete req.session.error;\n    delete req.session.success;\n    res.locals.message = '';\n    if (err) {\n        res.locals.message = '<p class=\"msg error\">' + err + '</p>';\n    }\n    if (msg) {\n        res.locals.message = '<p class=\"msg success\">' + msg + '</p>';\n    }\n    next();\n});\n\nfunction authenticate(name, pass, fn) {\n\tvar userinfo = Users;\n\tif (!module.parent) {\n        //console.log('authenticating %s:%s', name, pass);\n\t}\n\tdata_obj.UserQuery(name, function(temp) {\n\t\tif (temp === null) {\n\t\t\tconsole.log(\"cannot find user\");\n\t\t\treturn fn(new Error('cannot find user'));\n\t\t} else if (temp == \"DB_ERR\") {\n\t\t    console.log(\"DB_ERROR\");\n\t\t\treturn fn(new Error('DB_ERROR'));\n\t\t} else {\n            userinfo = JSON.parse(temp);\n            //console.log(\"Query Result:\" + userinfo.USERNAME);\n            //console.log(\"userinfo.SALT:\" + userinfo.SALT);\n            var password = require('pwd');\n            password.hash(pass, userinfo.SALT, function(err, hash) {\n                if (err) {\n                    return fn(err);\n                }\n                if (userinfo.HASH == hash) {\n                    console.log(\"User authenticate success:\" + name);\n                    return fn(null, temp); // yay\n                }\n                return fn(new Error('invalid password'));\n            });\n        }\n\t});\n}\n\nfunction restrict(req, res, next) {\n    if (req.session.user) {\n        //console.log(\"User: \" + req.session.user);\n        next();\n    } else {\n        req.session.error = 'Access denied!';\n        res.redirect('/login');\n    }\n}\n\napp.use(function(err, req, res, next) {\n    console.error(err.stack);\n    res.send(500, 'Something broke!');\n});\n\napp.get('/panel', restrict, function(req, res) {\n    res.sendfile('./public/admin.html');\n});\n\napp.get('/panel/accessibility', restrict, function(req, res) {\n    res.sendfile('./public/accessibility.html');\n});\n\napp.get('/tokin/:refresh?', restrict, function(req, res) {\n    var userinfo = Users;\n    if (req.params.refresh !== undefined) {\n        data_obj.UserQuery(req.session.user , function(temp) {\n            if(temp === undefined || temp === null || temp ===\"\") {\n                res.send(\"User not found!\");\n            }\n            else\n            {\n                userinfo = JSON.parse(temp);\n                crypto.randomBytes(16, function(ex, buf) {  \n                    userinfo.TOKIN = buf.toString('hex').toUpperCase();\n                    data_obj.UserUpdate(req.session.user, JSON.stringify(userinfo), function(result) {\n                        res.send(result);\n                    });\n                }); \n            }\n        });\n    } else {\n        data_obj.UserQuery(req.session.user , function(UserInfo) {\n            if(UserInfo === undefined || UserInfo === null || UserInfo ===\"\") {\n                res.send(\"User not found!\");\n            }\n            else\n            {\n                res.send(UserInfo);\n            }\n        });\n    }\n});\n\napp.get('/password/:new', restrict, function(req, res) {\n    var userinfo = Users;\n    data_obj.UserQuery(req.session.user , function(temp) {\n        if(temp === undefined || temp === null || temp ===\"\") {\n            res.send(\"User not found!\");\n        } else {\n            userinfo = JSON.parse(temp);\n            pass.hash(req.params.new, function(err, salt, hash) {\n                userinfo.SALT = salt;\n                userinfo.HASH = hash;\n                crypto.randomBytes(16, function(ex, buf) {  \n                    userinfo.TOKIN = buf.toString('hex').toUpperCase();\n                    data_obj.UserUpdate(userinfo.USERNAME, JSON.stringify(userinfo), function(temp) {\n                        authenticate(userinfo.USERNAME, req.params.new, function(err, userinfo) {\n                            if(err === null) {\n                                var user = JSON.parse(userinfo);\n                                if (user.USERNAME) {\n                                    req.session.regenerate(function() {\n                                        req.session.user = user.USERNAME;\n                                        req.session.success = 'Authenticated as ' + user.USERNAME\n                                          + ' click to <a href=\"/logout\">logout</a>. '\n                                          + ' You may now access <a href=\"/panel\">/panel</a>.';\n                                        res.send(user);\n                                    });\n                                }\n                            }\n                        });\n                    });\n                }); \n            });\n        }\n    });\n});\n\napp.get('/panel/device', restrict, function(req, res) {\n    res.sendfile('./public/device.html');\n});\n\napp.get('/panel/user', restrict, function(req, res) {\n    res.sendfile('./public/user.html');\n});\n\napp.get('/login', function(req, res) {\n    res.sendfile('./public/login.html');\n});\n\napp.get('/register', function(req, res) {\n    res.sendfile('./public/register.html');\n});\n\napp.get('/logout', function(req, res) {\n    // destroy the user's session to log them out\n    // will be re-created next request\n    req.session.destroy(function() {\n        res.redirect('/panel');\n    });\n});\n\napp.post('/register', function(req, res) {\n    var newUsers = Users;\n\tif(req.body.uname === \"\") {\n\t\tres.redirect('/error_uname');\n\t}\n\tif(req.body.email === \"\") {\n\t\tres.redirect('/error_email');\n\t}\n\tif(req.body.password === \"\") {\n\t\tres.redirect('/error_password');\n\t}\n\tnewUsers.USERNAME = req.body.uname;\n\tnewUsers.EMAIL = req.body.email;\n\t\n\tpass.hash(req.body.password, function(err, salt, hash) {\n\t\tnewUsers.SALT = salt;\n\t\tnewUsers.HASH = hash;\n\t\tcrypto.randomBytes(16, function(ex, buf) {  \n\t\t\tnewUsers.TOKIN = buf.toString('hex').toUpperCase();\n\t\t\tdata_obj.UserRegister(newUsers.USERNAME, JSON.stringify(newUsers), function(temp) {\n\t\t\t\t//res.send(temp);\n\t\t\t\tauthenticate(newUsers.USERNAME, req.body.password, function(err, userinfo) {\n                    if(err === null) {\n                        var user = JSON.parse(userinfo);\n                        if (user.USERNAME) {\n                            req.session.regenerate(function(){\n                            req.session.user = user.USERNAME;\n                            req.session.success = 'Authenticated as ' + user.USERNAME\n                              + ' click to <a href=\"/logout\">logout</a>. '\n                              + ' You may now access <a href=\"/panel\">/panel</a>.';\n                            res.redirect('/panel');\n                          });\n                        } else {\n                            req.session.error = 'Authentication failed, please check your '\n                            + ' username and password.';\n                            res.redirect('back');\n                        }\n                    } else {\n                        req.session.error = 'Authentication failed, please check your '\n                            + ' username and password.';\n                        res.redirect('/login');\n                    }\n                });\n\t\t\t});\n\t\t}); \n\t}); \n});\n\napp.post('/login', function(req, res) {\n    //console.log(req.body.uname);\n    //console.log(req.body.password);\n    if(req.body.uname === null || req.body.password === null)\n    {\n        console.log(\"Error ,username or password empty!\");\n        req.session.error = 'Authentication failed, please check your '\n            + ' username and password.';\n        res.redirect('/login');\n        \n    } else {\n        authenticate(req.body.uname, req.body.password, function(err, userinfo) {\n            if(err === null) {\n                var user = JSON.parse(userinfo);\n                if (user.USERNAME) {\n                  // Regenerate session when signing in\n                  // to prevent fixation\n                    req.session.regenerate(function(){\n                    // Store the user's primary key\n                    // in the session store to be retrieved,\n                    // or in this case the entire user object\n                    req.session.user = user.USERNAME;\n                    req.session.success = 'Authenticated as ' + user.USERNAME\n                      + ' click to <a href=\"/logout\">logout</a>. '\n                      + ' You may now access <a href=\"/panel\">/panel</a>.';\n                    //console.log(\"Login success:\" + user.USERNAME);\n                    res.redirect('/panel');\n                  });\n                } else {\n                  req.session.error = 'Authentication failed, please check your '\n                    + ' username and password.';\n                  res.redirect('back');\n                }\n            } else if (err == \"DB_ERROR\") {\n                console.log(\"ErrMsg:\" + err);\n                req.session.error = 'DBERROR';\n                res.redirect('/login');\n            } else {\n                //console.log(\"ErrMsg:\" + err);\n                //console.log(\"UserInfo:\" + userinfo);\n                req.session.error = 'Authentication failed, please check your '\n                    + ' username and password.';\n                res.redirect('/login');\n            }\n        });\n    }\n});\n\n//app.get(\"/user/delete/:user\" , function(req, res) {\n//\tdata_obj.UserRegister(req.params.user, \"\", function(temp) {\n//\t\tres.send(temp);\n//\t});\n//});\n//Resverd functions.\n//this functions can delete users.\n\n\n\napp.get(\"/user/delete\" ,restrict , function(req, res) {\n    var result = UserDelete;\n\tdata_obj.UserRegister(req.session.user, \"\", function(temp) {\n\t\treq.session.destroy(function() {\n            result.IsSuccess = \"true\";\n            res.send(JSON.stringify(result));\n        });\n\t});\n});\n\napp.get(\"/user\" ,restrict , function(req, res) {\n\tdata_obj.UserQuery(req.session.user , function(UserInfo) {\n\t\tif(UserInfo === undefined || UserInfo === null ||UserInfo ===\"\") {\n\t\t\tres.send(\"User not found!\");\n\t\t}\n\t\telse\n\t\t{\n\t\t\tres.send(UserInfo);\n\t\t}\n\t});\n});\n\napp.get('/wechat',function(req, res) {\n    wechat_obj.validateToken(req, res);\n});\n\napp.post('/wechat',function(req, res) {\n\t//var xmldata = wechat_obj.handler(req,res);\n\twechat_obj.handler(req, res);\n});\n\napp.get(\"/bind/:num/:id\", restrict, function(req, res) {\n\tvar userinfo = Users;\n\tif (req.params.num !== undefined && req.params.id !== undefined && req.session.user !== undefined) {\n        data_obj.UserQuery(req.session.user, function(temp) {\n            if (temp === null) {\n                console.log(\"cannot find user\");\n                res.send(\"cannot find user\");\n            } else {\n                userinfo = JSON.parse(temp);\n                if (req.params.num == \"1\") {\n                    userinfo.DEVICEID = req.params.id;\n                } else if (req.params.num == \"2\") {\n                    userinfo.DEVICEID2 = req.params.id;\n                }\n                //console.log(\"Query Result:\" + userinfo.USERNAME);\n                //console.log(\"\\nUserinfo.DEVICEID:\" + userinfo.DEVICEID);\n                \n                data_obj.UserUpdate(userinfo.USERNAME, JSON.stringify(userinfo), function(temp) {\n                    res.send(temp);\n                });\n            }\n        });\n\t}\n\telse {\n\t\tres.send(\"UserName / DeviceId error or not login!\");\n\t}\n});\n\napp.get(\"/device/:id/:slot?/:operation?\" , function(req, res) {\n\tvar json_out = DeviceState;\n\tjson_out.DeviceId = req.params.id;\n\tjson_out.ServerTime = moment().zone(timezone).format('YYYY-MM-DD, HH:mm:ss');\n\tif (req.params.operation !== undefined) {\n\t\tdata_obj.setRedis(req.params.id, null, req.params.slot, req.params.operation, function(temp) {\n\t\t\tjson_out.State = temp;\n\t\t\tsocket_obj.broadcast('SYSTEM',JSON.stringify(json_out) + '\\n');\n\t\t\tres.send(JSON.stringify(json_out));\n\t\t});\n\t}\n\telse {\n\t\tdata_obj.getRedis(req.params.id , function(temp) {\t\t\t\n\t\t\tjson_out.State = temp;\t\t\t\n\t\t\tsocket_obj.broadcast('SYSTEM',JSON.stringify(json_out) + '\\n');\n\t\t\tres.send(JSON.stringify(json_out));\n\t\t});\n\t}\n});\n\n\napp.get(\"/api/device/:num/:slot?/:operation?\", restrict, function(req, res) {\n\tvar json_out = DeviceState;\n    var userinfo = Users;\n\tjson_out.ServerTime = moment().zone(timezone).format('YYYY-MM-DD, HH:mm:ss');\n\tif (req.params.operation !== undefined) {\n        data_obj.UserQuery(req.session.user, function(temp) {\n            if (temp === null) {\n                console.log(\"cannot find user\");\n            } else {\n                userinfo = JSON.parse(temp);\n                if(userinfo.DEVICEID !== null && userinfo.DEVICEID !== \"\") {\n                    if (req.params.num == \"1\") {\n                        json_out.DeviceId = userinfo.DEVICEID;\n                    }\n                    if (req.params.num == \"2\") {\n                        json_out.DeviceId = userinfo.DEVICEID2;\n                    }\n                    data_obj.setRedis(json_out.DeviceId, null, req.params.slot, req.params.operation, function(temp) {\n                        json_out.State = temp;\n                        socket_obj.broadcast('SYSTEM',JSON.stringify(json_out) + '\\n');\n                        res.send(JSON.stringify(json_out));\n                    });                    \n                } else {\n                    res.send(ERR_NULL_ID);\n                }\n            }\n        });\n\t}\n\telse {\n        data_obj.UserQuery(req.session.user, function(temp) {\n            if (temp === null) {\n                console.log(\"cannot find user\");\n            } else {\n                userinfo = JSON.parse(temp);\n                if(userinfo.DEVICEID !== null && userinfo.DEVICEID !== \"\") {\n                    if (req.params.num == \"1\") {\n                        json_out.DeviceId = userinfo.DEVICEID;\n                    }\n                    if (req.params.num == \"2\") {\n                        json_out.DeviceId = userinfo.DEVICEID2;\n                    }\n                    //console.log(json_out.DEVICEID);\n                    data_obj.getRedis(json_out.DeviceId , function(temp) {\t\t\t\n                        json_out.State = temp;\n                        //socket_obj.broadcast('SYSTEM',JSON.stringify(json_out) + '\\n');\n                        res.send(JSON.stringify(json_out));\n                    });                   \n                } else {\n                    res.send(ERR_NULL_ID);\n                }\n            }\n        });\n        \n\t}\n});\n\napp.listen(httpport, function() {\n    console.log('HTTP  listening on port :%d', httpport);\n    console.log('Server started at :%s', moment().zone(timezone).format('YYYY-MM-DD, HH:mm:ss'));\n    setInterval(heartbeat_timer,heartbeat_check_interval);\n});\n","undoManager":{"mark":96,"position":100,"stack":[[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":67,"column":31},"end":{"row":67,"column":32}},"text":","}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":67,"column":31},"end":{"row":67,"column":32}},"text":","}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":67,"column":31},"end":{"row":67,"column":32}},"text":"."}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":40,"column":15},"end":{"row":40,"column":20}},"text":"false"},{"action":"insertText","range":{"start":{"row":40,"column":15},"end":{"row":40,"column":16}},"text":"t"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":40,"column":16},"end":{"row":40,"column":17}},"text":"r"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":40,"column":17},"end":{"row":40,"column":18}},"text":"u"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":40,"column":18},"end":{"row":40,"column":19}},"text":"e"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":40,"column":18},"end":{"row":40,"column":19}},"text":"e"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":40,"column":17},"end":{"row":40,"column":18}},"text":"u"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":40,"column":16},"end":{"row":40,"column":17}},"text":"r"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":40,"column":15},"end":{"row":40,"column":16}},"text":"t"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":40,"column":15},"end":{"row":40,"column":16}},"text":"f"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":40,"column":16},"end":{"row":40,"column":17}},"text":"a"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":40,"column":17},"end":{"row":40,"column":18}},"text":"l"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":40,"column":18},"end":{"row":40,"column":19}},"text":"s"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":40,"column":19},"end":{"row":40,"column":20}},"text":"e"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":70,"column":22},"end":{"row":70,"column":23}},"text":" "}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":70,"column":21},"end":{"row":70,"column":22}},"text":"o"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":70,"column":20},"end":{"row":70,"column":21}},"text":"t"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":70,"column":19},"end":{"row":70,"column":20}},"text":" "}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":70,"column":18},"end":{"row":70,"column":19}},"text":"1"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":70,"column":17},"end":{"row":70,"column":18}},"text":" "}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":70,"column":16},"end":{"row":70,"column":17}},"text":"e"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":70,"column":15},"end":{"row":70,"column":16}},"text":"s"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":70,"column":14},"end":{"row":70,"column":15}},"text":"a"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":70,"column":13},"end":{"row":70,"column":14}},"text":"e"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":70,"column":12},"end":{"row":70,"column":13}},"text":"r"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":70,"column":11},"end":{"row":70,"column":12}},"text":"c"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":70,"column":10},"end":{"row":70,"column":11}},"text":"n"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":70,"column":9},"end":{"row":70,"column":10}},"text":"i"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":70,"column":9},"end":{"row":70,"column":10}},"text":"s"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":70,"column":10},"end":{"row":70,"column":11}},"text":"e"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":70,"column":11},"end":{"row":70,"column":12}},"text":"t"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":70,"column":12},"end":{"row":70,"column":13}},"text":" "}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":70,"column":37},"end":{"row":70,"column":38}},"text":" "}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":70,"column":38},"end":{"row":70,"column":39}},"text":"t"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":70,"column":39},"end":{"row":70,"column":40}},"text":"o"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":70,"column":40},"end":{"row":70,"column":41}},"text":" "}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":70,"column":41},"end":{"row":70,"column":42}},"text":"N"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":69,"column":0},"end":{"row":69,"column":76}},"text":"\t\t//if device not online(heartbeat counter == 0) then set device count to N."},{"action":"removeText","range":{"start":{"row":68,"column":39},"end":{"row":69,"column":0}},"text":"\n"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":69,"column":8},"end":{"row":69,"column":9}},"text":" "}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":69,"column":7},"end":{"row":69,"column":8}},"text":"e"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":69,"column":6},"end":{"row":69,"column":7}},"text":"s"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":69,"column":5},"end":{"row":69,"column":6}},"text":"l"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":69,"column":4},"end":{"row":69,"column":5}},"text":"e"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":68,"column":0},"end":{"row":68,"column":39}},"text":"\t\t//and search online state form redis."},{"action":"removeText","range":{"start":{"row":67,"column":32},"end":{"row":68,"column":0}},"text":"\n"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":68,"column":37},"end":{"row":68,"column":38}},"text":"("}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":68,"column":38},"end":{"row":68,"column":39}},"text":")"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":68,"column":38},"end":{"row":68,"column":39}},"text":"s"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":68,"column":39},"end":{"row":68,"column":40}},"text":"i"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":68,"column":40},"end":{"row":68,"column":41}},"text":"m"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":68,"column":41},"end":{"row":68,"column":42}},"text":"i"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":68,"column":42},"end":{"row":68,"column":43}},"text":"l"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":68,"column":43},"end":{"row":68,"column":44}},"text":"e"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":68,"column":44},"end":{"row":68,"column":45}},"text":"r"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":68,"column":45},"end":{"row":68,"column":46}},"text":" "}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":68,"column":46},"end":{"row":68,"column":47}},"text":"t"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":68,"column":47},"end":{"row":68,"column":48}},"text":"o"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":68,"column":48},"end":{"row":68,"column":49}},"text":" "}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":68,"column":49},"end":{"row":68,"column":50}},"text":"T"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":68,"column":50},"end":{"row":68,"column":51}},"text":"T"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":68,"column":51},"end":{"row":68,"column":52}},"text":"L"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":68,"column":54},"end":{"row":68,"column":55}},"text":" "}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":68,"column":55},"end":{"row":68,"column":59}},"text":"mybe"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":68,"column":59},"end":{"row":68,"column":60}},"text":" "}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":68,"column":60},"end":{"row":68,"column":61}},"text":"N"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":68,"column":61},"end":{"row":69,"column":0}},"text":"\n"},{"action":"insertText","range":{"start":{"row":69,"column":0},"end":{"row":69,"column":2}},"text":"\t\t"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":69,"column":1},"end":{"row":69,"column":2}},"text":"\t"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":69,"column":0},"end":{"row":69,"column":1}},"text":"\t"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":68,"column":61},"end":{"row":69,"column":0}},"text":"\n"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":68,"column":61},"end":{"row":68,"column":62}},"text":" "}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":68,"column":62},"end":{"row":68,"column":63}},"text":"="}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":68,"column":63},"end":{"row":68,"column":64}},"text":" "}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":68,"column":64},"end":{"row":68,"column":88}},"text":"heartbeat_check_interval"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":68,"column":88},"end":{"row":68,"column":89}},"text":" "}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":68,"column":89},"end":{"row":68,"column":90}},"text":"×"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":68,"column":89},"end":{"row":68,"column":90}},"text":"×"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":68,"column":89},"end":{"row":68,"column":90}},"text":"×"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":68,"column":90},"end":{"row":68,"column":91}},"text":" "}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":68,"column":91},"end":{"row":68,"column":92}},"text":"6"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":68,"column":92},"end":{"row":68,"column":93}},"text":"。"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":68,"column":92},"end":{"row":68,"column":93}},"text":"。"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":67,"column":32},"end":{"row":68,"column":0}},"text":"\n"},{"action":"insertText","range":{"start":{"row":68,"column":0},"end":{"row":68,"column":2}},"text":"\t\t"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":68,"column":2},"end":{"row":68,"column":3}},"text":"c"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":68,"column":3},"end":{"row":68,"column":4}},"text":"o"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":68,"column":4},"end":{"row":68,"column":5}},"text":"n"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":68,"column":5},"end":{"row":68,"column":6}},"text":"s"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":68,"column":6},"end":{"row":68,"column":7}},"text":"o"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":68,"column":7},"end":{"row":68,"column":8}},"text":"l"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":68,"column":8},"end":{"row":68,"column":9}},"text":"e"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":68,"column":9},"end":{"row":68,"column":10}},"text":"."}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":68,"column":10},"end":{"row":68,"column":11}},"text":"l"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":68,"column":11},"end":{"row":68,"column":12}},"text":"o"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":68,"column":12},"end":{"row":68,"column":13}},"text":"g"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":68,"column":13},"end":{"row":68,"column":15}},"text":"()"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":68,"column":15},"end":{"row":68,"column":16}},"text":";"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":68,"column":14},"end":{"row":68,"column":29}},"text":"data.toString()"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":60,"column":1},"end":{"row":60,"column":2}},"text":"/"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":60,"column":2},"end":{"row":60,"column":3}},"text":"/"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":60,"column":2},"end":{"row":60,"column":3}},"text":"/"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":60,"column":1},"end":{"row":60,"column":2}},"text":"/"}]}]]},"ace":{"folds":[],"scrolltop":820.5,"scrollleft":0,"selection":{"start":{"row":60,"column":1},"end":{"row":60,"column":1},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":{"row":345,"state":"start","mode":"ace/mode/javascript"}},"timestamp":1406645525418}